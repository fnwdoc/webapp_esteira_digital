<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- O título agora reflete o "ganho" (previsibilidade) -->
    <title>Construtor de Receita Previsível FNW</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- INÍCIO: CSS Customizado (incorporado) -->
    <style>
        body {
            background-color: #f8f9fa;
            /* Fonte Inter para uma aparência mais moderna */
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .navbar-brand img {
            max-height: 40px;
        }

        /* Melhoria: Dashboard de Controle */
        .dashboard-control {
            background-color: #ffffff;
            border: none;
        }
        .status-caotico {
            background-color: #dc3545;
            color: white;
            font-size: 1rem;
            padding: 0.5em 1em;
            border-radius: 0.375rem;
        }
        .status-construindo {
            background-color: #ffc107;
            color: #333;
            font-size: 1rem;
            padding: 0.5em 1em;
            border-radius: 0.375rem;
        }
        .status-previsivel {
            background-color: #198754;
            color: white;
            font-size: 1rem;
            padding: 0.5em 1em;
            border-radius: 0.375rem;
        }
        .dashboard-control h4 {
            margin-bottom: 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: #0d6efd;
        }

        /* Melhoria: Visual da Jornada */
        .arrow-icon {
            font-size: 3rem;
            color: #adb5bd;
            font-weight: 200; /* Seta mais leve */
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: flex-start;
            margin-top: 100px; /* Alinha com os cards */
        }

        .product-column {
            background-color: #f1f3f5; /* Tom de cinza mais leve */
            border-radius: 12px; /* Mais arredondado */
            padding: 16px;
            min-height: 400px;
            height: 100%;
        }

        .column-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        .column-header h4 {
            font-weight: 600; /* Um pouco menos "pesado" que bold */
        }
        .column-header i {
            font-size: 0.9rem;
            color: #0d6efd;
            cursor: help;
        }

        /* Card do Produto */
        .product-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-left: 5px solid #0d6efd; /* Cor padrão */
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px; /* Mais arredondado */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Sombra mais suave */
        }
        .product-card h6 {
            font-weight: 600;
            margin-bottom: 5px;
            color: #212529;
        }
        .product-card .price {
            font-weight: 600;
            color: #198754;
            font-size: 1.1rem;
        }

        /* Melhoria: Destaque "Mapa do Tesouro" */
        .product-card.mapa-tesouro {
            border-left: 5px solid #ffc107; /* Borda dourada */
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
            background: #fffbeb;
        }
        .product-card .mapa-tesouro-badge {
            font-size: 0.75rem;
            font-weight: bold;
            color: #a67c00;
        }

        /* Melhoria: Info "Próxima Venda" */
        .proxima-venda-info {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6c757d;
            border-top: 1px dashed #e0e0e0;
            padding-top: 8px;
        }
        .proxima-venda-info strong {
            color: #343a40;
        }

        /* Responsividade: Scroll horizontal em desktop */
        .jornada-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 1.5rem; /* Espaço para a barra de scroll */
        }
        .product-column-wrapper {
            flex: 0 0 auto;
            width: 300px; /* Largura fixa para cada coluna */
            margin-right: 15px;
        }
        .arrow-icon-wrapper {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-right: 15px;
        }
         /* Responsividade: Quebra de linha em mobile */
         @media (max-width: 767.98px) {
            .dashboard-control .col-md-4 {
                margin-bottom: 15px;
            }
             .arrow-icon {
                transform: rotate(90deg); /* Vira a seta para baixo */
                margin-top: 15px;
                margin-bottom: 15px;
            }
            .jornada-container {
                flex-wrap: wrap; /* Quebra as colunas em vez de scrollar */
                overflow-x: hidden;
            }
            .product-column-wrapper {
                width: 100%; /* Coluna ocupa 100% da largura */
                margin-right: 0;
            }
             .arrow-icon-wrapper {
                width: 100%;
                padding-right: 0;
            }
        }
    </style>
    <!-- FIM: CSS Customizado -->
</head>
<body>

    <nav class="navbar navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://d1yei2z3i6k35z.cloudfront.net/3119789/67d0fd43833ed_FNWfreenatstoreLogodownload.jpg" alt="Logo FNW" height="40">
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Títulos focados na dor e ganho -->
        <div class="text-center">
            <h1>Construtor de Receita Previsível FNW</h1>
            <p class="lead">O Fim da Receita Inconstante: Desenhe sua Jornada de LTV.</p>
        </div>

        <!-- INÍCIO: Dashboard de Controle (Melhoria) -->
        <div class="dashboard-control card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center text-center gy-3 gy-md-0">
                    <div class="col-md-4">
                        <h5>Status da Previsibilidade</h5>
                        <span id="status-previsibilidade" class="badge status-caotico">Caótico</span>
                    </div>
                    <div class="col-md-4">
                        <h4><strong id="contador-produtos">0</strong></h4>
                        <small>Produtos Mapeados</small>
                    </div>
                    <div class="col-md-4">
                        <h4><strong id="contador-conexoes">0</strong></h4>
                        <small>Conexões de Próxima Venda</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- FIM: Dashboard de Controle -->

        <!-- Controles principais (Nome e Botões) -->
        <div class="row mb-3 gy-2 gy-md-0">
            <div class="col-md-4">
                <label for="clientName" class="form-label">Nome do Cliente/Projeto</label>
                <input type="text" class="form-control" id="clientName" placeholder="Ex: Meu Negócio Digital">
            </div>
            <div class="col-md-8 d-flex align-items-end justify-content-start justify-content-md-end flex-wrap gap-2">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#productModal">
                    <i class="bi bi-plus-circle"></i> Cadastrar Produto
                </button>
                <!-- Texto do botão focado no resultado -->
                <button class="btn btn-primary" id="btn-exportar">
                    <i class="bi bi-download"></i> Salvar Mapa
                </button>
                <label for="import-json" class="btn btn-outline-primary mb-0">
                    <i class="bi bi-upload"></i> Carregar Mapa
                </label>
                <input type="file" id="import-json" class="d-none" accept=".json">
            </div>
        </div>

        <hr>

        <!-- INÍCIO: Esteira de Produtos FNW (Melhoria Visual da Jornada) -->
        <div class="jornada-container">

            <!-- LTi -->
            <div class="product-column-wrapper">
                <div class="product-column">
                    <div class="column-header">
                        <h4>LTi</h4>
                        <h5>Low Ticket</h5>
                        <small>(&lt; R$ 500)</small>
                    </div>
                    <div class="product-list" id="lti-list">
                        <!-- Cards de produto são inseridos aqui via JS -->
                    </div>
                </div>
            </div>

            <!-- Seta visual da jornada -->
            <div class="arrow-icon-wrapper"><div class="arrow-icon">→</div></div>

            <!-- MTi -->
            <div class="product-column-wrapper">
                <div class="product-column">
                    <div class="column-header">
                        <h4>MTi</h4>
                        <h5>Mid Ticket</h5>
                        <small>(R$ 500 - R$ 3.000)</small>
                    </div>
                    <div class="product-list" id="mti-list">
                        <!-- Cards de produto são inseridos aqui via JS -->
                    </div>
                </div>
            </div>

            <!-- Seta visual da jornada -->
            <div class="arrow-icon-wrapper"><div class="arrow-icon">→</div></div>

            <!-- HTi -->
            <div class="product-column-wrapper">
                <div class="product-column">
                    <div class="column-header">
                        <h4>HTi 
                            <!-- Tooltip estratégico (Pilar 3) -->
                            <i class="bi bi-info-circle-fill" data-bs-toggle="tooltip" title="Pilar 3: A Oferta Premium. Como esta mentoria ou serviço escala seu lucro e compra sua liberdade?"></i>
                        </h4>
                        <h5>High Ticket</h5>
                        <small>(R$ 3.000 - R$ 25.000)</small>
                    </div>
                    <div class="product-list" id="hti-list">
                        <!-- Cards de produto são inseridos aqui via JS -->
                    </div>
                </div>
            </div>

            <!-- Seta visual da jornada -->
            <div class="arrow-icon-wrapper"><div class="arrow-icon">→</div></div>

            <!-- DUN -->
            <div class="product-column-wrapper">
                <div class="product-column">
                    <div class="column-header">
                        <h4>DUN
                            <!-- Tooltip estratégico (Pilar 3) -->
                            <i class="bi bi-info-circle-fill" data-bs-toggle="tooltip" title="Pilar 3 (Máximo): O 'Done For You' ou serviço de altíssimo valor que representa o maior lucro."></i>
                        </h4>
                        <h5>DUN</h5>
                        <small>(&gt; R$ 25.000)</small>
                    </div>
                    <div class="product-list" id="dun-list">
                        <!-- Cards de produto são inseridos aqui via JS -->
                    </div>
                </div>
            </div>

        </div>
        <!-- FIM: Esteira de Produtos FNW -->
    </div>

    <!-- Modal: Cadastrar/Editar Produto (Com Melhorias) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Cadastrar Novo Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productTitle" class="form-label">Título do Produto</label>
                        <input type="text" class="form-control" id="productTitle">
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">Preço Sugerido (R$)</label>
                        <input type="number" class="form-control" id="productPrice" placeholder="Ex: 49.90">
                        <div class="form-text">O sistema irá posicionar o produto automaticamente.</div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Descrição Breve</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <!-- INÍCIO: Melhoria Pilar 1: Mapa do Tesouro -->
                    <div class="form-check form-switch mb-3" id="mapa-tesouro-toggle">
                        <input class="form-check-input" type="checkbox" role="switch" id="isMapaTesouro">
                        <label class="form-check-label" for="isMapaTesouro">
                            <strong>Marcar como "Mapa do Tesouro"</strong>
                            <small class="d-block text-muted">(O "sim fácil" que transforma curiosos em clientes)</small>
                        </label>
                    </div>
                    <!-- FIM: Melhoria Pilar 1 -->

                </div>
                <div class="modal-footer">
                    <!-- Botão deletar movido para a esquerda para clareza -->
                    <button type="button" class="btn btn-outline-danger" id="btn-delete" style="display: none; margin-right: auto;">Deletar Produto</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-save">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Detalhes e Conexão (Melhoria Pilar 2) -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailProductTitle">Detalhe do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row gy-3">
                        <!-- Coluna de Detalhes -->
                        <div class="col-md-7">
                            <h3 id="detailTitle"></h3>
                            <h4 class="text-success" id="detailPrice"></h4>
                            <!-- white-space: pre-wrap preserva a formatação da descrição (quebras de linha) -->
                            <p id="detailDescription" style="white-space: pre-wrap;"></p>
                        </div>
                        <!-- INÍCIO: Melhoria Pilar 2: Máquina de Próxima Venda -->
                        <div class="col-md-5">
                            <div class="card bg-light p-3">
                                <h5><i class="bi bi-diagram-3-fill"></i> Máquina de Próxima Venda</h5>
                                <p class="text-muted small">Para qual produto esta oferta deve levar o cliente?</p>
                                <div class="mb-3">
                                    <label for="link-proxima-venda" class="form-label">Conectar com:</label>
                                    <select class="form-select" id="link-proxima-venda">
                                        <option value="">Nenhuma (Fim da esteira)</option>
                                        <!-- Opções carregadas via JS -->
                                    </select>
                                </div>
                                <p class="text-muted small">Isto constrói seu sistema automático que oferece a "coisa certa, na hora certa".</p>
                            </div>
                        </div>
                        <!-- FIM: Melhoria Pilar 2 -->
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-primary" id="btn-edit-product">
                        <i class="bi bi-pencil-fill"></i> Editar Produto
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SortableJS via CDN for Drag-and-Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <!-- INÍCIO: App JS Customizado (incorporado) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let products = [];
            let currentEditingProductId = null;
            const clientNameInput = document.getElementById('clientName');

            // Inicialização dos Modais do Bootstrap
            const productModalEl = document.getElementById('productModal');
            const productModal = new bootstrap.Modal(productModalEl);
            
            const detailModalEl = document.getElementById('detailModal');
            const detailModal = new bootstrap.Modal(detailModalEl);

            // Inicialização dos Tooltips (Melhoria Pilar 3)
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // --- Elementos do DOM ---
            const btnSave = document.getElementById('btn-save');
            const btnDelete = document.getElementById('btn-delete');
            const btnExport = document.getElementById('btn-exportar');
            const btnEditProduct = document.getElementById('btn-edit-product');
            const importInput = document.getElementById('import-json');
            const linkProximaVendaSelect = document.getElementById('link-proxima-venda');

            // --- Funções Principais ---

            /**
             * Renderiza todos os produtos nas colunas corretas e atualiza o dashboard.
             * Esta é a função central que atualiza a UI.
             */
            function renderApp() {
                // Limpa as listas antes de renderizar
                document.getElementById('lti-list').innerHTML = '';
                document.getElementById('mti-list').innerHTML = '';
                document.getElementById('hti-list').innerHTML = '';
                document.getElementById('dun-list').innerHTML = '';

                // Cria e insere o card de cada produto na coluna correta
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    const columnId = product.columnId || getColumnForPrice(product.price);
                    document.getElementById(columnId).appendChild(productCard);
                });

                // Atualiza o dashboard de controle
                updateDashboard();
            }

            /**
             * Cria o elemento HTML (card) para um produto.
             * Esta função contém as melhorias visuais dos Pilares 1 e 2.
             */
            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card shadow-sm';
                card.dataset.id = product.id;
                
                // Melhoria Pilar 1: Adiciona destaque "Mapa do Tesouro"
                let mapaTesouroBadge = '';
                if (product.isMapaTesouro) {
                    card.classList.add('mapa-tesouro');
                    mapaTesouroBadge = '<div class="mapa-tesouro-badge"><i class="bi bi-key-fill"></i> Mapa do Tesouro</div>';
                }

                // Melhoria Pilar 2: Adiciona info "Próxima Venda"
                let proximaVendaInfo = '';
                if (product.proximaVendaId) {
                    const nextProduct = products.find(p => p.id === product.proximaVendaId);
                    if (nextProduct) {
                        proximaVendaInfo = `
                            <div class="proxima-venda-info">
                                <i class="bi bi-arrow-right-circle"></i> Leva para: <strong>${nextProduct.title}</strong>
                            </div>
                        `;
                    }
                }

                // Conteúdo do card
                card.innerHTML = `
                    ${mapaTesouroBadge}
                    <h6>${product.title}</h6>
                    <div class="price">R$ ${parseFloat(product.price).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    ${proximaVendaInfo}
                `;

                // Adiciona evento de clique para abrir o modal de detalhes
                card.addEventListener('click', () => {
                    currentEditingProductId = product.id;
                    openDetailModal(product.id);
                });

                return card;
            }

            /**
             * Salva um produto (novo ou editado).
             */
            function saveProduct() {
                const id = document.getElementById('productId').value;
                const title = document.getElementById('productTitle').value;
                // Trata vírgula (,) e ponto (.) no preço
                const price = parseFloat(document.getElementById('productPrice').value.replace(',', '.')); 
                const description = document.getElementById('productDescription').value;
                const isMapaTesouro = document.getElementById('isMapaTesouro').checked;

                if (!title || isNaN(price) || price <= 0) {
                    // Feedback de erro (sem usar alert)
                    console.error('Título e Preço (válido) são obrigatórios.');
                    // Aqui seria um bom lugar para mostrar uma mensagem de erro no modal
                    return;
                }

                if (id) {
                    // Editando um produto existente
                    const product = products.find(p => p.id === id);
                    product.title = title;
                    product.price = price;
                    product.description = description;
                    product.columnId = getColumnForPrice(price); // Atualiza a coluna ao editar
                    // Só permite marcar como Mapa do Tesouro se for LTi
                    product.isMapaTesouro = (getColumnForPrice(price) === 'lti-list') ? isMapaTesouro : false;
                } else {
                    // Criando um novo produto
                    const newProduct = {
                        id: `fnw_${Date.now()}`, // ID único
                        title,
                        price,
                        description,
                        columnId: getColumnForPrice(price), // Adiciona a coluna inicial
                        // Só permite marcar como Mapa do Tesouro se for LTi
                        isMapaTesouro: (getColumnForPrice(price) === 'lti-list') ? isMapaTesouro : false,
                        proximaVendaId: null // Melhoria Pilar 2: Inicia sem conexão
                    };
                    products.push(newProduct);
                }

                renderApp(); // Atualiza a UI
                productModal.hide(); // Fecha o modal
            }

            /**
             * Deleta um produto.
             */
            function deleteProduct() {
                if (!currentEditingProductId) return;

                // Em vez de window.confirm(), apenas deletamos.
                // Um modal de confirmação seria o ideal.
                products = products.filter(p => p.id !== currentEditingProductId);
                
                // Remove conexões quebradas (que apontavam para este produto deletado)
                products.forEach(p => {
                    if (p.proximaVendaId === currentEditingProductId) {
                        p.proximaVendaId = null;
                    }
                });
                
                currentEditingProductId = null;
                renderApp(); // Atualiza a UI
                productModal.hide(); // Fecha o modal
            }

            /**
             * Abre o modal de "Cadastrar Produto", limpando ou preenchendo os campos.
             */
            function resetProductModal(product = null) {
                currentEditingProductId = product ? product.id : null;
                document.getElementById('productId').value = product ? product.id : '';
                document.getElementById('productTitle').value = product ? product.title : '';
                document.getElementById('productPrice').value = product ? product.price : '';
                document.getElementById('productDescription').value = product ? product.description : '';
                document.getElementById('isMapaTesouro').checked = product ? product.isMapaTesouro : false;

                document.getElementById('productModalLabel').textContent = product ? 'Editar Produto' : 'Cadastrar Novo Produto';
                btnDelete.style.display = product ? 'block' : 'none';

                // Lógica para mostrar/ocultar o toggle "Mapa do Tesouro"
                const price = parseFloat(product ? product.price : 0);
                const column = getColumnForPrice(price);
                const toggle = document.getElementById('mapa-tesouro-toggle');
                
                if (product && column !== 'lti-list') {
                    toggle.style.display = 'none';
                    document.getElementById('isMapaTesouro').checked = false; // Garante que não fique marcado
                } else {
                    toggle.style.display = 'block';
                }
            }
            
            /**
             * Abre o modal de "Detalhes" e preenche as conexões (Pilar 2).
             */
            function openDetailModal(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;

                currentEditingProductId = productId;

                // Preenche os detalhes básicos
                document.getElementById('detailTitle').textContent = product.title;
                document.getElementById('detailPrice').textContent = `R$ ${parseFloat(product.price).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('detailDescription').textContent = product.description;

                // Melhoria Pilar 2: Popula o Dropdown de "Próxima Venda"
                linkProximaVendaSelect.innerHTML = '<option value="">Nenhuma (Fim da esteira)</option>';
                products.forEach(p => {
                    if (p.id !== product.id) { // Não pode linkar para si mesmo
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.title} (R$ ${p.price})`;
                        if (p.id === product.proximaVendaId) {
                            option.selected = true; // Marca a conexão existente
                        }
                        linkProximaVendaSelect.appendChild(option);
                    }
                });

                detailModal.show();
            }
            
            /**
             * Salva a conexão da "Próxima Venda" (Pilar 2) quando o select é alterado.
             */
            function saveProximaVendaLink() {
                const selectedId = linkProximaVendaSelect.value;
                const product = products.find(p => p.id === currentEditingProductId);
                if (product) {
                    product.proximaVendaId = selectedId || null;
                    renderApp(); // Atualiza a UI para mostrar a nova conexão
                }
            }

            /**
             * Atualiza o "Dashboard de Controle" (Melhoria 4) com o status atual.
             */
            function updateDashboard() {
                const numProdutos = products.length;
                const numConexoes = products.filter(p => p.proximaVendaId).length;

                document.getElementById('contador-produtos').textContent = numProdutos;
                document.getElementById('contador-conexoes').textContent = numConexoes;

                const statusSpan = document.getElementById('status-previsibilidade');
                
                // Lógica de status
                if (numProdutos === 0) {
                    statusSpan.textContent = 'Caótico';
                    statusSpan.className = 'badge status-caotico';
                } else if (numConexoes < numProdutos / 2) {
                    statusSpan.textContent = 'Em Construção';
                    statusSpan.className = 'badge status-construindo';
                } else {
                    statusSpan.textContent = 'Previsível';
                    statusSpan.className = 'badge status-previsivel';
                }
            }


            /**
             * Inicializa a funcionalidade de arrastar e soltar (Drag-and-Drop) em todas as colunas.
             */
            function initializeSortable() {
                const lists = document.querySelectorAll('.product-list');
                lists.forEach(list => {
                    new Sortable(list, {
                        group: 'products', // Permite arrastar entre listas do mesmo grupo
                        animation: 150,
                        ghostClass: 'blue-background-class', // Classe CSS para o "fantasma"
                        onEnd: (evt) => {
                            const itemEl = evt.item; // O card que foi movido
                            const toListId = evt.to.id; // A ID da lista de destino
                            const productId = itemEl.dataset.id;

                            const product = products.find(p => p.id === productId);
                            if (product) {
                                // Atualiza o estado interno do produto com a nova coluna
                                product.columnId = toListId;
                                // Não é necessário chamar renderApp() aqui, a biblioteca cuida da UI.
                                // Mas se houver lógica de estado complexa, pode ser necessário.
                            }
                        }
                    });
                });
            }

            // --- Funções Auxiliares ---

            /**
             * Retorna o ID da coluna (lista) com base no preço.
             */
            function getColumnForPrice(price) {
                if (price < 500) return 'lti-list';
                if (price >= 500 && price < 3000) return 'mti-list';
                if (price >= 3000 && price < 25000) return 'hti-list';
                if (price >= 25000) return 'dun-list';
                return 'lti-list'; // Default para preços 0 ou inválidos
            }

            // --- Funções de Import/Export (JSON) ---

            /**
             * Exporta o estado atual (produtos e nome do cliente) como um arquivo JSON.
             */
            function exportJSON() {
                const clientName = clientNameInput.value.trim().replace(/\s+/g, '_') || 'meu-mapa';
                const data = {
                    clientName: clientNameInput.value.trim(),
                    products: products
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `mapa_previsibilidade_${clientName}.json`);
                document.body.appendChild(downloadAnchorNode); // Necessário para Firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            /**
             * Importa um estado (arquivo JSON) e renderiza a aplicação.
             */
            function importJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.products && Array.isArray(data.products)) {
                            // Adiciona compatibilidade para mapas antigos sem columnId
                            data.products.forEach(p => {
                                if (!p.columnId) {
                                    p.columnId = getColumnForPrice(p.price);
                                }
                            });
                            products = data.products;
                            clientNameInput.value = data.clientName || '';
                            renderApp();
                        } else {
                            console.error('Arquivo JSON inválido: falta a propriedade "products".');
                        }
                    } catch (error) {
                        console.error('Erro ao ler o arquivo JSON:', error);
                    }
                };
                reader.readAsText(file);
                // Limpa o input para permitir carregar o mesmo arquivo novamente
                event.target.value = null; 
            }

            // --- Event Listeners (Configuração Inicial) ---

            // Abre o modal de "Novo Produto"
            productModalEl.addEventListener('show.bs.modal', (event) => {
                // Reseta o modal APENAS se não foi acionado pelo botão "Editar"
                if (event.relatedTarget && event.relatedTarget.id !== 'btn-edit-product') {
                    resetProductModal();
                }
            });
            
            // Validação em tempo real do "Mapa do Tesouro" ao digitar o preço
            document.getElementById('productPrice').addEventListener('input', (e) => {
                const price = parseFloat(e.target.value.replace(',', '.')) || 0;
                const column = getColumnForPrice(price);
                const toggle = document.getElementById('mapa-tesouro-toggle');
                
                if (column !== 'lti-list') {
                    toggle.style.display = 'none';
                    document.getElementById('isMapaTesouro').checked = false; // Desmarca se mudar de LTi
                } else {
                    toggle.style.display = 'block';
                }
            });

            // Botão Salvar
            btnSave.addEventListener('click', saveProduct);

            // Botão Deletar
            btnDelete.addEventListener('click', deleteProduct);

            // Botão Exportar
            btnExport.addEventListener('click', exportJSON);

            // Input de Importar
            importInput.addEventListener('change', importJSON);

            // Botão "Editar Produto" (dentro do modal de detalhes)
            btnEditProduct.addEventListener('click', () => {
                const product = products.find(p => p.id === currentEditingProductId);
                if (product) {
                    detailModal.hide(); // Fecha modal de detalhes
                    resetProductModal(product); // Preenche modal de edição
                    productModal.show(); // Abre modal de edição
                }
            });
            
            // Salva a conexão (Pilar 2)
            linkProximaVendaSelect.addEventListener('change', saveProximaVendaLink);

            // Renderização inicial
            renderApp();
            initializeSortable(); // Ativa o Drag-and-Drop
        });
    </script>
    <!-- FIM: App JS Customizado -->
</body>
</html>
